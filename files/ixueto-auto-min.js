// ==UserScript==
// @name         行知学徒网 自动人脸识别
// @namespace    https://github.com/reuAC/ixueto
// @version      1.0
// @description  auto
// @author       reuAC
// @match        https://www.ixueto.com/*
// @match        https://kcapp.ixueto.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=ixueto.com
// @grant        none
// ==/UserScript==

(function(){function l(c){var f=document.createElement("div");f.textContent=c;return f}function m(c){var f=c.clientY-n;a.style.left=c.clientX-p+"px";a.style.top=f+"px"}var d;localStorage.getItem("G_faceData")?d=localStorage.getItem("G_faceData"):d=!1;var a=document.createElement("div"),p,n,e=document.createElement("input");e.type="file";e.addEventListener("change",function(c){c=c.target.files[0];var f=new FileReader;f.onload=function(q){var g=document.createElement("img");g.src=q.target.result;var k=document.createElement("canvas"),r=k.getContext("2d");g.onload=function(){k.width=g.width;k.height=g.height;r.drawImage(g,0,0);d=k.toDataURL("image/jpeg");localStorage.setItem("G_faceData",d);a.innerHTML="\u8bf7\u5237\u65b0\u9875\u9762\u3002"}};f.readAsDataURL(c)});a.style.position="fixed";a.style.top="50px";a.style.left="50px";a.style.width="200px";a.style.height="150px";a.style.backgroundColor="#f0f0f0";a.style.border="1px solid #ccc";a.style.borderRadius="5px";a.style.boxShadow="2px 2px 5px rgba(0, 0, 0, 0.3)";a.style.zIndex="1000";a.style.cursor="move";a.style.userSelect="none";a.appendChild(l("\u6210\u529f\u52a0\u8f7d\u811a\u672c"));d?a.appendChild(l("\u5df2\u8d8a\u8fc7\u4eba\u8138\u8bc6\u522b")):a.appendChild(l("\uff01\uff01\u60a8\u9700\u8981\u8fdb\u884c\u4eba\u8138\u56fe\u7247\u8f7d\u5165\u624d\u80fd\u8df3\u8fc7\u4eba\u8138\u8bc6\u522b\uff01\uff01"));a.appendChild(e);document.body.appendChild(a);a.addEventListener("mousedown",function(c){p=c.clientX-a.getBoundingClientRect().left;n=c.clientY-a.getBoundingClientRect().top;document.addEventListener("mousemove",m)});document.addEventListener("mouseup",function(){document.removeEventListener("mousemove",m)});var b=document.documentElement.outerHTML;e=document.createElement("script");e.type="text/javascript";if(d)if("www.ixueto.com"==window.location.hostname){var h=/data: \{ action: 'ComparePhotoInfo', ([^\}]*) \}/;h=b.match(h);var t=b.match(/data: \{ action: 'SaveScreenShotInfo', ([^\}]*) \}/),u=b.match(/BOSUpload\.uploadBase64\(nbase64, true, \{([^}]*)\}/);b=b.match(/\{ action: "normalEndMark", ([^\}]*) \}/);e.innerHTML=`var sendSrc="${d}";function faceCheck(stage){if(isfinish==1&&stage==1)return false;if(existModel){return false}if(showtip==false){return false}livingChecked(stage)}function livingChecked(stage){let tips=$("#tips");const monitor_minute=600000;function checkEnd(){layer.close(layer.index)}function saveCallBack(){setTimeout(checkEnd,1500);if(isfinish!=1){setTimeout(function(){faceCheck(1)},monitor_minute)}}function saveCallBack_End(){tips.text("\u8bfe\u7a0b\u5df2\u7ed3\u675f...");$("#s_message").html("\u8bfe\u7a0b\u5df2\u7ed3\u675f");setTimeout(checkEnd,1500);setTimeout(function(){if('1'=='1'&&'2'!='0'){test()}else{if('0'=='1'){fun_autonextLesson()}}},3000)}function normalEndMark(){$.post("ashx/course.ashx",${b[0]},function(result){if(result.flag){saveCallBack_End()}},"json")}function saveScreenShot(base64,state,callback){var path=BOSUpload.getScreenShortPath("790294",27884);canvasDataURL(base64,{width:300,height:0},function(nbase64,width,height){${u[0]},function(path){$.ajax({type:"POST",dataType:"json",cache:false,url:"/web/NewAshx/Personal.ashx",${t[0]},success:function(){supervise=0;jg_code="";$("#s_message2").html("");callback()}})})})}(function compareFace(tips){faceData="${d}";$.ajax({type:"POST",dataType:"json",cache:false,url:"/web/NewAshx/Personal.ashx",${h[0]},success:function(result){if(result!=null&&result.flag){if(notargetCheck.notarget_decide_time>0){notargetCheck.endCheck()}nErrorTimes=0;t1=1;t2=1;if(stage!=2){tips.text("\u8bc6\u522b\u6210\u529f\uff0c\u8ba1\u65f6\u4e2d...");$("#s_message2").html("");saveScreenShot(faceData,1,saveCallBack)}else{saveScreenShot(faceData,1,normalEndMark)}}else{sendNum++;if(nErrorTimes==0){updatetimes(4)}nErrorTimes++;if(isFirst>0){isFirst=0;t1=0;t2=0}if(result!=null&&result.showMess!=null&&result.showMess!=""){tips.text("\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21\uff0c"+result.showMess)}else{tips.text("\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21")}setTimeout(recheck,2000);if(faceData!=null&&faceData.length>30&&sendNum==10){saveScreenShot(faceData,0)}}},error:function(e){sendNum++;if(nErrorTimes==0){updatetimes(5)}nErrorTimes++;if(isFirst>0){isFirst=0;t1=0;t2=0}tips.text("\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21");setTimeout(recheck,2000);if(faceData!=null&&faceData.length>30&&sendNum==10){saveScreenShot(faceData,0)}}})})(tips)}`}else{if(h=/\{\s*action: 'ComparePhotoInfo', ([^\}]*) \}/g,b=b.match(h))if(b[1]){var [v,w]=b[0].length>b[1].length?[b[0],b[1]]:[b[1],b[0]];e.innerHTML=`window.onload=function(){setTimeout(()=>{screenshot()},1000)}function screenshot(){var sendSrc="${d}";var ss="";$.ajax({type:"POST",dataType:"json",cache:false,url:"../web/NewAshx/Personal.ashx",data:${w},success:function(result){if(result!=null&&result.flag){if(nErrorTimes>0){sendNum=0}faceState=true;sendNum+=100;$("#p_mark").html('');$("#s_message2").html("\u8bc6\u522b\u6210\u529f");if(isFirst==0){startTime=new Date();isFirst++}nErrorTimes=0;SaveScreenShot(sendSrc,1);}else{faceState=false;if(sendNum>100){sendNum=0}sendNum++;nErrorTimes++;if(nErrorTimes>40&&isFirst>0){isFirst=0}setTimeout("screenshot()",3000);startTime=new Date();if(result!=null&&result.showMess!=null&&result.showMess!="")$("#s_message2").html("\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21\uff0c"+result.showMess+ss);else $("#s_message2").html("\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21"+ss);if(nErrorTimes%10==0){alert("\u8fde\u7eed"+nErrorTimes+"\u6b21\u672a\u68c0\u6d4b\u5230\u4f60\u672c\u4eba\uff0c\u8bf7\u786e\u8ba4\u4f60\u672c\u4eba\u5728\u89c6\u9891\u65c1\u8fb9")}if(sendSrc!=null&&sendSrc.length>30&&sendNum>=100){SaveScreenShot(sendSrc,0)}}},error:function(){if(sendNum>100){sendNum=0}faceState=false;sendNum++;nErrorTimes++;setTimeout("screenshot()",3000);startTime=new Date();$("#s_message2").html("\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21"+ss);if(nErrorTimes%10==0){alert("\u63a5\u53e3\u9519\u8bef")}if(sendSrc!=null&&sendSrc.length>30&&sendNum>=100){SaveScreenShot(sendSrc,0)}}})}function ScreenShotSubmitExam(){$("#cam").show();$("#s_message2").html("\u8003\u8bd5\u7ed3\u675f\u9700\u8981\u622a\u56fe,\u8bf7\u8fdb\u884c\u4eba\u8138\u8bc6\u522b...");var sendSrc="${d}";var ss="";$.ajax({type:"POST",dataType:"json",cache:false,url:"../web/NewAshx/Personal.ashx",data:${v},success:function(result){if(result!=null&&result.flag){if(nErrorTimes>0){sendNum=0}sendNum+=100;$("#s_message2").html("\u4eba\u8138\u8bc6\u522b\u6210\u529f\uff0c\u6b63\u5728\u63d0\u4ea4\u8003\u8bd5\u3002\u3002\u3002");if(isFirst==0){startTime=new Date();isFirst++}nErrorTimes=0;allow=true;SaveScreenShotSubmitExam(sendSrc,1)}else{allow=false;if(sendNum>=20){sendNum=0}sendNum++;nErrorTimes++;if(nErrorTimes>10&&videoState==0){$("#cam").show();videoState=1}setTimeout("ScreenShotSubmitExam()",3000);if(result!=null&&result.showMess!=null&&result.showMess!="")$("#s_message2").html("\u4eba\u8138\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21\u3002"+result.showMess+ss);else $("#s_message2").html("\u4eba\u8138\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21\u3002"+ss);if(sendSrc!=null&&sendSrc.length>30&&sendNum>=20){SaveScreenShot(sendSrc,0)}}},error:function(){allow=false;if(sendNum>=20){sendNum=0}if(nErrorTimes>10&&videoState==0){$("#cam").show();videoState=1}sendNum++;nErrorTimes++;setTimeout("ScreenShotSubmitExam()",3000);$("#s_message2").html("\u4eba\u8138\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21\u3002"+ss);if(sendSrc!=null&&sendSrc.length>30&&sendNum>=20){SaveScreenShot(sendSrc,0)}}})}`}else e.innerHTML=`window.onload=function(){setTimeout(()=>{screenshot()},1000)}function screenshot(){var sendSrc="${d}";var ss="";$.ajax({type:"POST",dataType:"json",cache:false,url:"../web/NewAshx/Personal.ashx",data:${b[0]},success:function(result){if(result!=null&&result.flag){if(nErrorTimes>0){sendNum=0}faceState=true;sendNum+=100;$("#p_mark").html('');$("#s_message2").html("\u8bc6\u522b\u6210\u529f");if(isFirst==0){startTime=new Date();isFirst++}nErrorTimes=0;SaveScreenShot(sendSrc,1);}else{faceState=false;if(sendNum>100){sendNum=0}sendNum++;nErrorTimes++;if(nErrorTimes>40&&isFirst>0){isFirst=0}setTimeout("screenshot()",3000);startTime=new Date();if(result!=null&&result.showMess!=null&&result.showMess!="")$("#s_message2").html("\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21\uff0c"+result.showMess+ss);else $("#s_message2").html("\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21"+ss);if(nErrorTimes%10==0){alert("\u8fde\u7eed"+nErrorTimes+"\u6b21\u672a\u68c0\u6d4b\u5230\u4f60\u672c\u4eba\uff0c\u8bf7\u786e\u8ba4\u4f60\u672c\u4eba\u5728\u89c6\u9891\u65c1\u8fb9")}if(sendSrc!=null&&sendSrc.length>30&&sendNum>=100){SaveScreenShot(sendSrc,0)}}},error:function(){if(sendNum>100){sendNum=0}faceState=false;sendNum++;nErrorTimes++;setTimeout("screenshot()",3000);startTime=new Date();$("#s_message2").html("\u8bc6\u522b\u5931\u8d25"+nErrorTimes+"\u6b21"+ss);if(nErrorTimes%10==0){alert("\u63a5\u53e3\u9519\u8bef")}if(sendSrc!=null&&sendSrc.length>30&&sendNum>=100){SaveScreenShot(sendSrc,0)}}})}`}else e.innerHTML="function faceCheck(){}window.onload=function(){}";document.body.appendChild(e)})();